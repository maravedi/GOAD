[CmdletBinding()]
param()

Set-StrictMode -Version Latest

$configuration = @{
    syncIntervalMinutes        = {{ azure_ad_connect.sync_settings.sync_interval_minutes | int }}
    deltaSyncThresholdMinutes  = {{ azure_ad_connect.sync_settings.delta_sync_threshold_minutes | int }}
    exportDeletionThreshold    = {{ azure_ad_connect.sync_settings.export_deletion_threshold | int }}
    enablePasswordHashSync     = {{ azure_ad_connect.sync_settings.enable_password_hash_sync | ternary('$true', '$false') }}
    enablePasswordWriteback    = {{ azure_ad_connect.sync_settings.enable_password_writeback | ternary('$true', '$false') }}
    enableDeviceWriteback      = {{ azure_ad_connect.sync_settings.enable_device_writeback | ternary('$true', '$false') }}
    stagingMode                = {{ azure_ad_connect.sync_settings.staging_mode | ternary('$true', '$false') }}
}

$result = [ordered]@{
    module = 'hardening.ad_stig.azure_ad_connect'
    action = 'configure_sync'
    status = 'ok'
    updated = @()
}

try {
    Import-Module ADSync -ErrorAction Stop

    $interval = New-TimeSpan -Minutes $configuration.syncIntervalMinutes
    $schedulerParams = @{
        CustomizedSyncInterval   = $interval
        NextSyncCyclePolicyType  = 'Delta'
        SyncCycleEnabled         = (-not $configuration.stagingMode)
        PurgeRunHistoryInterval  = (New-TimeSpan -Days 30)
    }
    Set-ADSyncScheduler @schedulerParams -ErrorAction Stop
    $result.updated += 'scheduler'

    Set-ADSyncAADCompanyFeature -PasswordHashSync $configuration.enablePasswordHashSync -ErrorAction Stop
    $result.updated += 'password_hash_sync'

    Set-ADSyncAADCompanyFeature -PasswordWriteback $configuration.enablePasswordWriteback -ErrorAction Stop
    $result.updated += 'password_writeback'

    Set-ADSyncAADCompanyFeature -DeviceWriteback $configuration.enableDeviceWriteback -ErrorAction Stop
    $result.updated += 'device_writeback'

    if ($configuration.exportDeletionThreshold -gt 0) {
        Enable-ADSyncExportDeletionThreshold -DeletionThreshold $configuration.exportDeletionThreshold -ErrorAction Stop
        $result.updated += 'export_deletion_threshold'
    }

    if (-not $configuration.stagingMode) {
        $scheduler = Get-ADSyncScheduler
        $policy = 'Delta'

        if ($null -ne $scheduler.LastSyncCycleStartTime) {
            $last = $scheduler.LastSyncCycleStartTime.ToUniversalTime()
            $ageMinutes = [math]::Floor(((Get-Date).ToUniversalTime() - $last).TotalMinutes)
            if ($ageMinutes -ge $configuration.deltaSyncThresholdMinutes) {
                $policy = 'Initial'
            }
        }
        else {
            $policy = 'Initial'
        }

        Start-ADSyncSyncCycle -PolicyType $policy -ErrorAction Stop | Out-Null
        $result.updated += "sync_cycle_$policy"
    }
}
catch {
    $result.status = 'error'
    $result.error = $_.Exception.Message
    $result | ConvertTo-Json -Depth 4 -Compress | Write-Output
    exit 1
}

$result | ConvertTo-Json -Depth 4 -Compress | Write-Output
exit 0
